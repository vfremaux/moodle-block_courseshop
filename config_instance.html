<?php
require_once $CFG->dirroot.'/blocks/courseshop/paymodes/paymode.class.php';
require_once $CFG->dirroot.'/blocks/courseshop/shop/lib.php';

$usehtmleditor = can_use_html_editor();

if (empty($CFG->block_courseshop_defaultcurrency)){
	set_config('block_courseshop_defaultcurrency', 'EUR');
}

if (isset($this->config->currency)){
	$currency = $this->config->currency;
} else {
	$currency = $CFG->block_courseshop_defaultcurrency;
}

if (isset($this->config->defaultcountry)){
	$country = $this->config->defaultcountry;
} else {
	$country = @$CFG->block_courseshop_defaultcountry;
}

if (!isset($this->config->printtabbedcategory)){
	$this->config->printtabbedcategory = false;
}

?>

<fieldset id="connection">
<legend><?php print_string('shop', 'block_courseshop') ?></legend>
<table cellpadding="9" cellspacing="0" width="90%">
<tr valign="top">
    <td align="right"><b><?php print_string('configtitle', 'block_courseshop'); ?>:</b></td>
    <td align="left">
        <input type="text" name="blocktitle" size="30" value="<?php echo isset($this->config->blocktitle)? p($this->config->blocktitle) : '' ; ?>" />
    </td>
</tr>
<tr valign="top">
    <td align="right"><b><?php print_string('shopcaption', 'block_courseshop'); ?>:</b></td>
    <td align="left">
        <input type="text" name="shopcaption" size="30" value="<?php echo isset($this->config->shopcaption)? p($this->config->shopcaption) : '' ; ?>" />
    </td>
</tr>
<tr valign="top">
    <td align="right"><b><?php print_string('shopdescription', 'block_courseshop'); ?>:</b>
        <?php
                helpbutton('writing', get_string('helpwriting'), 'moodle', true, true);
                echo "<br />";
                if ($usehtmleditor) {
                   helpbutton('richtext', get_string('helprichtext'), 'moodle', true, true);
                } else {
                   helpbutton('text', get_string('helptext'), 'moodle', true, true);
                   echo "<br />";
                   emoticonhelpbutton('addtaskform', 'description', 'moodle', true, true);
                   echo "<br />";
                }
        ?>    	
    </td>
    <td align="left">
        <?php
           print_textarea($usehtmleditor, 20, 60, 595, 400, 'shopdescription', @$this->config->shopdescription);
    
           if ($usehtmleditor) {
               echo '<input type="hidden" name="format" value="'.FORMAT_HTML.'" />';
               $nohtmleditorneeded = false;
           } else {
               echo '<p align="right">';
               helpbutton('textformat', get_string('formattexttype'));
               print_string('formattexttype');
               echo ':&nbsp;';
               choose_from_menu(format_text_menu(), 'shopdescription', $defaultformat, '');
               echo '</p>';
           }
		?>
    </td>
</tr>
<tr valign="top">
    <td align="right"><b><?php print_string('catalogue', 'block_courseshop'); ?>:</b></td>
    <td align="left">
        <?php
		    if ($cats = get_records('courseshop_catalog')){
                foreach($cats as $cat){
					$catoptions[$cat->id] = $cat->name;
				}
                choose_from_menu($catoptions, 'catalogue', @$this->config->catalogue, 'choose');
            } else {
                print_string('nocatalogs', 'block_courseshop');
                $context = get_context_instance(CONTEXT_BLOCK, $this->instance->id);
                if (has_capability('block/courseshop:salesadmin', $context)){
                    $gotoadminstr = get_string('gotoadminlink', 'block_courseshop');
                    echo "<br/><a href=\"{$CFG->wwwroot}/blocks/courseshop/index.php\">$gotoadminstr</a>";
                }
            }
        ?>
    </td>
</tr>

<tr valign="top">
    <td align="right"><b><?php print_string('enablepaymodes', 'block_courseshop'); ?>:</b></td>
    <td align="left">
		
	<?php

		//Checking paymodes availability and creating checkboxes	
		$paymodes = courseshop_paymode::courseshop_get_plugins($this);
		foreach($paymodes as $pm){
			if ($pm->enabled)
				$pm->print_instance_config();
		}	 
		print_string('carefullchoice', 'block_courseshop');
	?>
    </td> 
</tr>
<tr valign="top">
    <td align="right"><b><?php print_string('currency', 'block_courseshop'); ?>:</b></td>
    <td align="left">
        <?php
        	$currencies = courseshop_get_supported_currencies();
        	choose_from_menu($currencies, 'currency', $currency);
        ?>
    </td>
</tr>
<tr valign="top">
    <td align="right"><b><?php print_string('customerdefaultcountry', 'block_courseshop'); ?>:</b></td>
    <td align="left">
        <?php
		    $choices = get_list_of_countries();
		    if (!empty($this->config->catalogid)){
		    	$theCatalog = get_record('courseshop_catalog', 'id', $this->config->catalogid);
			    courseshop_process_country_restrictions($choices, $theCatalog);
			}
        	choose_from_menu($choices, 'defaultcountry', $country);
        ?>
    </td>
</tr>

<tr valign="top">
    <td align="right"><b><?php print_string('customerorganisationrequired', 'block_courseshop'); ?>:</b></td>
    <td align="left">
    	<?php
    	$yeschecked = (@$this->config->customerorganisationrequired) ? 'checked="checked"' : '' ;
    	$nochecked = (@$this->config->customerorganisationrequired) ? 'checked="checked"' : '' ;
    	?>
    	<input type="radio" name="customerorganisationrequired" value="0" <?php echo $nochecked ?> /> <?php print_string('no') ?>
    	- <input type="radio" name="customerorganisationrequired" value="1" <?php echo $yeschecked ?> /> <?php print_string('yes') ?>
    </td>
</tr>

<tr valign="top">
    <td align="right"><b><?php print_string('printtabbedcategories', 'block_courseshop'); ?>:</b></td>
    <td align="left">
    	<?php
    	$yeschecked = (@$this->config->printtabbedcategories) ? 'checked="checked"' : '' ;
    	$nochecked = (@$this->config->printtabbedcategories) ? 'checked="checked"' : '' ;
    	?>
    	<input type="radio" name="printtabbedcategories" value="0" <?php echo $nochecked ?> /> <?php print_string('no') ?>
    	- <input type="radio" name="printtabbedcategories" value="1" <?php echo $yeschecked ?> /> <?php print_string('yes') ?>
    </td>
</tr>

<tr>
    <td colspan="6" align="center">
        <input type="submit" value="<?php print_string('savechanges') ?>" />
    </td>
</tr>
</table>
</fieldset>
</table>
<?php
	if ($usehtmleditor){
        use_html_editor('shopdescription');
	}
?>
